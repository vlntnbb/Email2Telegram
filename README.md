# Email2Telegram

Сервис для пересылки писем в Telegram в формате PDF.

## Версия
**Текущая версия:** 1.3.1

## Функциональность

- Автоматическая проверка почтового ящика на новые письма
- Конвертация содержимого писем в PDF с сохранением оформления
- Отправка PDF-документа в чат Telegram
- Команда для ручной проверки писем
- Фильтрация писем по белому списку отправителей
- Поддержка масок домена для фильтрации писем (*@domain.com)
- Отправка писем в разные топики (темы) в Telegram-группе
- Отображение комментариев к пересланным письмам

## История изменений

### v1.3.1
- Добавлена команда для тестирования настроенных топиков (/test_topic)
- Улучшено логирование и отладка сервиса
- Исправлены ошибки при работе с топиками в Telegram

### v1.3.0
- Добавлено отображение комментариев к пересланным письмам в сообщениях Telegram
- Улучшена обработка изображений в PDF-файлах, теперь картинки корректно отображаются

### v1.2.0
- Добавлена поддержка топиков (тем) в Telegram для организации писем
- Возможность настройки топика по умолчанию и назначения топиков для конкретных отправителей
- Команды для управления настройками топиков

### v1.1.0
- Добавлена поддержка масок доменов для фильтрации писем (*@domain.com)
- Улучшена структура команд для управления белым списком

### v1.0.0
- Первая рабочая версия сервиса
- Базовая функциональность проверки почты и отправки PDF в Telegram
- Поддержка белого списка отправителей
- Команда для ручной проверки новых писем

## Требования

- Node.js 14+ (проект оптимизирован для работы с Node.js версии 14 и выше)
- Учетная запись электронной почты с IMAP доступом
- Telegram бот токен и ID чата

## Установка

1. Клонировать репозиторий
2. Установить зависимости: `npm install`
3. Создать файл `.env` в корне проекта со следующим содержимым:

```
# Email settings
EMAIL_HOST=imap.example.com
EMAIL_PORT=993
EMAIL_USER=your_email@example.com
EMAIL_PASSWORD=your_password
EMAIL_TLS=true

# Telegram settings
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
TELEGRAM_CHAT_ID=your_telegram_chat_id

# Server settings
SERVER_PORT=3000
```

## Запуск

```bash
npm start
```

## Команды Telegram-бота

### Управление белым списком

- `/whitelist` - показать список разрешенных email-адресов
- `/add email@example.com` - добавить email в белый список
- `/add *@domain.com` - добавить все адреса с домена
- `/remove email@example.com` - удалить email из белого списка
- `/check` - проверить новые письма
- `/status` - проверить статус сервиса

### Управление топиками

- `/topics` - показать настройки топиков
- `/set_default_topic ID` - установить топик по умолчанию
- `/clear_default_topic` - очистить топик по умолчанию
- `/set_topic email@example.com ID` - задать топик для email
- `/set_topic *@domain.com ID` - задать топик для всех адресов с домена
- `/remove_topic email@example.com` - удалить привязку топика
- `/test_topic` - проверить работу настроенного топика

## Как работает фильтрация писем

Если белый список пуст, принимаются письма от всех отправителей.
После добавления хотя бы одного адреса в белый список, принимаются только
письма от указанных отправителей.

Вы можете добавить как конкретные адреса (`user@example.com`), так и маски доменов (`*@example.com`).

### Примеры использования масок доменов

1. Добавить все адреса с домена example.com в белый список:
   ```
   /add *@example.com
   ```

2. Комбинировать конкретные адреса и домены:
   ```
   /add user1@gmail.com
   /add *@company.com
   ```

## Как работают топики

Топики (темы) в Telegram позволяют организовать сообщения в группе по категориям. Для использования этой функции:

1. Группа должна быть супергруппой с включенными темами
2. ID темы можно узнать, нажав на название темы (число в конце URL)

### Примеры использования топиков

1. Установить тему по умолчанию (ID 123):
   ```
   /set_default_topic 123
   ```

2. Установить тему для конкретного email-адреса:
   ```
   /set_topic user@example.com 456
   ```

3. Установить тему для всех писем с домена:
   ```
   /set_topic *@example.com 789
   ```

4. Проверить работу настроенного топика:
   ```
   /test_topic
   ```

## Troubleshooting

- Если письма не приходят, проверьте правильность настроек в файле .env
- Белый список email-адресов и масок доменов хранится в файле data/whitelist.json
- Настройки топиков хранятся в файле data/topic_settings.json
- Формат маски домена: `*@domain.com`

## Рекомендации по настройке почты

### Gmail
- Включите IMAP доступ в настройках (Настройки -> См. все настройки -> Пересылка и POP/IMAP -> Включить IMAP)
- Создайте пароль приложения:
  1. Перейдите в настройки безопасности аккаунта Google
  2. Включите двухфакторную аутентификацию
  3. Создайте пароль приложения (Безопасность -> Двухэтапная аутентификация -> Пароли приложений)
  4. Используйте этот пароль в настройках приложения

### Yandex
- Включите IMAP в настройках (Все настройки -> Почтовые программы)
- Используйте пароль от почты или создайте пароль приложения

### Mail.ru
- Включите IMAP в настройках (Настройки -> Все настройки -> Почтовые программы)
- Используйте специальный пароль для внешних приложений

## Telegram бот

1. Создайте нового бота через @BotFather:
   - Отправьте команду /newbot
   - Укажите имя и username для бота
   - Получите токен бота и сохраните его
2. Добавьте бота в нужный чат
3. Получите ID чата:
   - Добавьте @getidsbot в свой чат
   - Используйте полученный ID (обычно отрицательное число для группового чата)
4. Укажите токен и ID чата в файле .env

## Совместимость с версиями Node.js

Приложение протестировано и работает с Node.js версии 14.x. Если вы используете более новую версию Node.js и сталкиваетесь с проблемами, рекомендуется использовать Node Version Manager (nvm) для установки Node.js 14:

```
nvm install 14
nvm use 14
npm install
npm start
``` 